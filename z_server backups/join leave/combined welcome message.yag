{{/* WELCOME MESSAGE
Regex trigger: \A
Set it to only run in main talk channel
*/}}


{{$verified := 1048764993925034065}} {{/* verified role ID */}}
{{$main := 750541618389712900}}{{/* main talk channel */}}
{{$id := .Message.Author.ID}} {{/* User ID of person who entered server */}}
{{$joins := 954832185200898128}} {{/* joins-leaves modlog channel - for successful verifications */}}
{{$modlog := 970007312632795167 }} {{/* yag-cmd-log */}}
{{$intros := 1252109363678675004}}
{{$db := 0}}

{{/* exec'd CCs */}}
{{$verify := 331 }} {{/* only for legacy verify */}}
{{$roles := 332}}
{{$vpr := 373}}

{{/* announcement post */}}
{{$announce := (complexMessage "content" (print "<@" $id "> ğŸ¥³") "embed" (cslice (cembed "thumbnail" (sdict "url" "https://bentovid.com/user/images/confettiball.png") "color" 43775 "description"  (print "**Welcome to BentoVid, <@" $id ">!**\nWhy not tell us how you found us & what brings you here?")) (cembed "color" 16744192 "description" (print "**Optional things to do**\n\n ğŸ”¸ <#1049023382680784978>\n ğŸ”¸ Manage your <id:customize> \n ğŸ”¸ Create your <#" $intros ">\n ğŸ”¸ Follow forum posts about your <#1167606763508478022>\n ğŸ”¸ Sit in on some <#1020462143230980216>\n\n[More Server Guides](https://bentovid.com/sguides)" )) ))}}



{{if eq .Message.Type 7}}
    {{deleteTrigger 1}} 
    
    {{$jdb := (dbGet .User.ID "joindate")}}
    

    {{if $jdb}}
      {{$db = 1}}
    {{end}}

  {{if (eq $jdb.Value.vdate "N/A" ) }}{{/* if this is their first time joining */}}
      {{sendMessage $main $announce }}
  {{end}}

  {{/* give verification role */}}
  {{giveRoleID $id $verified}}

  {{/* update verification / joindate db */}}

  {{$vcdb := (dbGet 0 "vcount").Value}}
  {{dbSet 0 "vcount" (add $vcdb 1)}}

  {{if eq $db 1}}
      {{$jdb := (dbGet $id "joindate")}}

      {{$jinfo := sdict
      "joined" $jdb.Value.joined
      "vdate" (print "<t:" currentTime.Unix ">")
      "left" $jdb.Value.left
      }}

      {{dbSet $id "joindate" $jinfo}}
      
  {{else}}
      {{dbSet $id "joindate" (sdict "joined" (print (humanizeDurationHours (currentTime.Sub (getMember $id).JoinedAt.Parse)) " ago" ) "vdate" (print "<t:" currentTime.Unix ">") "left" "Never" ) }}
  {{end}}

  {{/* send message to logs */}}
  {{ $VerifyMsg := (print "ğŸ—ï¸ \nğŸŸ¨ **<@" $id "> ("  (getMember $id).User ") Verified.** \nğŸŸ¨ (ID: " $id ") \nğŸŸ¨ <t:" currentTime.Unix ">\nğŸŸ¨ **Time Taken: " (humanizeDurationHours (currentTime.Sub (getMember $id).JoinedAt.Parse)) "** \n<:br:937128105821216898> *Membercount: " .Guild.MemberCount "*" ) }}

  {{ sendMessage $joins $VerifyMsg }}
{{return}}
{{end}}

{{/* legacy verify */}}
{{if (not (hasRoleID $verified) )}}
  {{execCC $verify nil 0 (sdict "user" $id "db" $db) }}
  {{return}}
{{end}}

{{/* VPR WARNING */}}
	{{ execCC $vpr nil 0 .Message}} 


